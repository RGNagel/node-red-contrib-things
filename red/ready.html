<script type="text/javascript">

  RED.nodes.registerType('Thing Ready', {
    paletteLabel: 'ready',
    category: 'things',
    color: '#D8BFD8',
    defaults: {
      nodeName: { value: '' },
      output: { value: 'all' },
      thingType: { value: 'all' },
      props: { value: [{ p: "prop", vt: "str" }] },
    },
    inputs: 0,
    outputs: 1,
    icon: 'font-awesome/fa-thumbs-up',
    label: function () {
      return this.nodeName || `On ${this.output == 'type' ? this.thingType + ' ' : ''}ready`
    },
    labelStyle: function () {
      return this.nodeName || this.output == 'type' ? 'node_label_italic' : ''
    },
    oneditresize: function (size) {
      var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
      var height = size.height;
      for (var i = 0; i < rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-input-property-container-row");
      height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
      height += 16;
      $("#node-input-property-container").editableList('height', height);
    },
    oneditprepare: function () {
      // TRIGGER PATH
      if (this.output != 'type') {
        $('#row-thingType').hide()
      }
      $('#node-input-output').change(function () {
        if ($(this).val() == 'type') {
          if ($('#node-input-thingType').val() == 'all') $('#node-input-thingType').val('')
          $('#row-thingType').show()
        } else {
          $('#node-input-thingType').val('all')
          $('#row-thingType').hide()
        }
      })
      // ------

      $('#node-input-property-container').css('min-height', '120px').css('min-width', '450px').editableList({
        addItem: function (container, i, opt) {
          var prop = opt;
          if (!prop.hasOwnProperty('p')) {
            prop = { p: "", v: "", vt: "str" };
          }
          container.css({
            overflow: 'hidden',
            whiteSpace: 'nowrap'
          });
          var row = $('<div/>').appendTo(container);

          var propertyName = $('<input/>', { class: "node-input-prop-property-name", type: "text" })
            .css("width", "30%")
            .appendTo(row)
            .typedInput({ types: ['msg'] });

          $('<div/>', { style: 'display:inline-block; padding:0px 6px;' })
            .text('=')
            .appendTo(row);

          var propertyValue = $('<input/>', { class: "node-input-prop-property-value", type: "text" })
            .css("width", "calc(70% - 30px)")
            .appendTo(row)
            .typedInput({ default: 'str', types: ['flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'] });

          propertyName.typedInput('value', prop.p);
          propertyValue.typedInput('value', prop.v);
          propertyValue.typedInput('type', prop.vt);
        },
        removable: true,
        sortable: true
      });

      if (!this.props) {
        this.props = [{
          p: 'prop',
          v: '',
          vt: 'str'
        }];
      }

      this.props.forEach(prop => {
        $("#node-input-property-container").editableList('addItem', prop);
      })
    },
    oneditsave: function () {
      var props = $("#node-input-property-container").editableList('items');
      var node = this;
      node.props = [];
      delete node.payloadType;
      delete node.payload;
      node.topic = "";
      props.each(function (i) {
        var prop = $(this);
        var p = {
          p: prop.find(".node-input-prop-property-name").typedInput('value')
        }
        if (p.p) {
          p.v = prop.find(".node-input-prop-property-value").typedInput('value');
          p.vt = prop.find(".node-input-prop-property-value").typedInput('type');
          node.props.push(p);
        }
      });
    }
  })
</script>

<script type="text/html" data-template-name="Thing Ready">
  <div class="form-row">
      <label for="node-input-nodeName"><i class="fa fa-tag"></i> Node Name</label>
      <input type="text" id="node-input-nodeName" placeholder="Node Name">
  </div>
  <div class="form-row">
      <label for="node-input-output"><i class="fa fa-list"></i> Output...</label>
      <select id="node-input-output" style="width: 70%">
        <option value='all'>When all things are ready</option>
        <option value='type'>When things of type are ready...</option>
      </select>
  </div>
  <div class="form-row" id="row-thingType">
    <label for="node-input-thingType">&nbsp;</label>
    <input type="text" id="node-input-thingType">
  </div>
  <div class="form-row node-input-property-container-row">
    <ol id="node-input-property-container"></ol>
  </div>
</script>

<script type="text/html" data-help-name="Thing Ready">
  <p>A node that outputs a message when a the system is ready (i.e. all things have been setup). Use similar to the <code>inject</code> node.</p>
</script>