<script type="text/javascript">
  function genMultiParams(obj = {}) {
    obj.multiKey = $('#node-input-multi-1').typedInput('type')
    let path = $('#node-input-multi-1').typedInput('value')
    if (obj.multiKey == 'props' && path) obj.multiKey += '.' + path
    obj.multiTest = $('#node-input-multi-2').typedInput('type')
    obj.multiValue = $('#node-input-multi-2').typedInput('value')
    return obj
  }

  RED.nodes.registerType('Thing Trigger', {
    paletteLabel: 'trigger',
    category: 'things',
    color: '#D8BFD8',
    defaults: {
      nodeName: { value: '' },
      multiMode: { value: false },
      multiKey: { value: 'name' },
      multiValue: { value: '' },
      multiTest: { value: 'str' },
      name: { value: '' },
      output: { value: 'change' }, // What causes the node to trigger an output msg
      outputPath: { value: '' },
      outputTest: { value: null },
      ignoreInit: { value: false },
      payload: { value: 'whole' }, // What is sent in the payload of the output msg
      payloadPath: { value: '' },
      incThing: { value: false }
    },
    inputs: 0,
    outputs: 1,
    icon: 'trigger.svg',
    label: function () {
      return this.nodeName || (this.multiMode ? `Multi mode` : this.name) || 'trigger'
    },
    labelStyle: function () {
      return this.nodeName || (!this.multiMode && this.name) ? 'node_label_italic' : ''
    },
    oneditprepare: function () {
      // Following variables are declared globally in test.html
      // operators, thingPropsTypes, basicTypes, typeTypes

      let StateType = {
        value: 'str',
        label: 'state.',
        validate: /^[0-9a-zA-Z_\.]*$/
      }
      let basicTypes = ['flow', 'global', 'str', 'num', 'env']

      // MULTI-MODE KEY

      if (this.multiMode) {
        $('#row-thingName').hide()
      } else {
        $('#row-thingTest').hide()
      }
      $('#node-input-multiMode').change(function () {
        if ($(this).prop('checked')) {
          $('#row-thingName').hide()
          $('#row-thingTest').show()
          $('#thing-test-results').show()
        } else {
          $('#row-thingName').show()
          $('#row-thingTest').hide()
          $('#thing-test-results').hide()
        }
      })

      let multi1 = $('#node-input-multi-1')
      let multi2 = $('#node-input-multi-2')

      multi1.typedInput({
        default: this.multiKey || 'name',
        types: thingPropsTypes.filter(tpt => tpt.value != 'state')
      })
      let typesForProps = ['str', 'num', 'bool', 're']
      let typesForNonProps = [
        {
          value: 'str',
          icon: 'red/images/typedInput/az.png',
          label: 'exact'
        },
        're'
      ]

      if (this.multiKey && this.multiKey.startsWith('props')) {
        multi1.typedInput('type', 'props')
        multi1.typedInput('value', this.multiKey.slice(6))

        multi2.typedInput({ types: typesForProps })
      } else {
        multi2.typedInput({ types: typesForNonProps })
      }
      multi1.on('change', function (xx, valType) {
        let newTypes = valType == 'props' ? typesForProps : typesForNonProps
        multi2.typedInput('types', newTypes)
        updateMatches()
      })

      multi2.typedInput('type', this.multiTest)
      multi2.typedInput('value', this.multiValue)
      multi2.on('change', updateMatches)

      // Get list of all things currently configured; for updateMatches()
      const things = {}
      const THINGS = []
      RED.nodes.eachNode(node => {
        node.type == 'Thing Setup' &&
          node.things &&
          node.things.forEach(thing => {
            things[thing.name] = thing
            THINGS.push(thing)
          })
      })

      function updateMatches() {
        // Get current configuration
        let { multiValue, multiTest, multiKey } = genMultiParams()

        // Make test (similar to what happens at trigger.js)
        if (multiTest == 're') multiValue = new RegExp(multiValue)
        let test = {
          str: value => multiValue == value,
          num: value => +multiValue == value,
          bool: value => (multiValue == 'true') == value,
          re: value => multiValue.test(value)
        }[multiTest]

        // Copied from trigger.js
        function recurFindThings(name) {
          let thing = things[name] || {}
          return thing.type == 'Group' ? thing.things.flatMap(recurFindThings) : [thing.name]
        }

        // Copied from trigger.js and modified
        let matches =
          multiKey == 'group'
            ? THINGS.filter(thing => thing.type == 'Group' && test(thing.name)).flatMap(group =>
                recurFindThings(group.name)
              )
            : THINGS.filter(thing => {
                try {
                  return test(RED.utils.getMessageProperty(thing, multiKey))
                } catch (err) {
                  console.log(`Unable to test ${thing.name} for ${multiKey}: ${err}`)
                  return false
                }
              }).map(thing => thing.name)

        let results = $('#thing-test-results')
        results.empty()

        let num = $('<span>')
          .text(`Matches ${matches.length} thing${matches.length == 1 ? '' : 's'}`)
          .appendTo(results)

        let list = $('<ul>')
          .append(matches.map(name => $('<li>').text(name)))
          .appendTo(results)
          .hide()

        num.on('click', () => list.toggle())
      }
      if (this.multiMode) updateMatches()

      // TRIGGER PATH

      let compare = $('#node-input-outputTest-compare')
      let forVal = $('#node-input-outputTest-for')

      operators
        .filter(opt => !/btwn|istype/.test(opt.v))
        .forEach(opt => $('<option>', { value: opt.v }).text(opt.t).appendTo(compare))

      let optShide = val =>
        forVal.typedInput(operators.find(o => o.v == val).hasValue === false ? 'hide' : 'show')

      $('#node-input-outputPath').typedInput({ types: [StateType] })
      forVal.typedInput({ types: basicTypes, default: 'str' }).typedInput('width', '140px')
      if (this.output != 'path') $('#row-outputPath, #row-outputTest, #row-ignoreInit').hide()

      if (this.outputTest) {
        $('#node-input-outputTest-checkbox').prop('checked', true)
        compare.val(this.outputTest.compare)
        forVal.typedInput('type', this.outputTest.type)
        forVal.typedInput('value', this.outputTest.value)
        optShide(this.outputTest.compare)
      }
      $('#node-input-output').change(function () {
        let hideShow = $(this).val() == 'path' ? 'show' : 'hide'
        $('#row-outputPath, #row-outputTest, #row-ignoreInit')[hideShow]()
      })
      compare.change(function () {
        optShide($(this).val())
      })

      // PAYLOAD PATH

      $('#node-input-payloadPath').typedInput({ types: [StateType] })
      if (this.payload != 'path') $('#row-payloadPath').hide()
      $('#node-input-payload').change(function () {
        let hideShow = $(this).val() == 'path' ? 'show' : 'hide'
        $('#row-payloadPath')[hideShow]()
      })
    },
    oneditsave: function () {
      // Multi-mode
      if (this.multiMode) genMultiParams(this)

      // Advanced-trigger-mode
      if (this.output == 'path') {
        if ($('#node-input-outputTest-checkbox').prop('checked')) {
          this.outputTest = {
            compare: $('#node-input-outputTest-compare').val(),
            type: $('#node-input-outputTest-for').typedInput('type'),
            value: $('#node-input-outputTest-for').typedInput('value')
          }
        } else {
          this.outputTest = null
        }
      }
    }
  })
</script>

<script type="text/html" data-template-name="Thing Trigger">
  <div class="form-row">
    <label for="node-input-nodeName"><i class="fa fa-tag"></i> Node Name</label>
    <input type="text" id="node-input-nodeName" placeholder="Node Name" />
  </div>
  <div class="form-row">
    <label for="node-input-multiMode">&nbsp;</label>
    <input
      type="checkbox"
      id="node-input-multiMode"
      style="display:inline-block; width:15px; vertical-align:baseline;"
    />
    <span> Use multi-<i>thing</i> mode</span>
  </div>
  <div class="form-row" id="row-thingName">
    <label for="node-input-name"><i class="fa fa-id-badge"></i> Thing Name</label>
    <input type="text" id="node-input-name" placeholder="Thing Name" />
  </div>
  <div class="form-row" id="row-thingTest">
    <label for="node-input-name"><i class="fa fa-copy"></i> Thing Test</label>
    <input type="text" id="node-input-multi-1" style="width: 35%" />
    <input type="text" id="node-input-multi-2" style="width: 40%" />
  </div>
  <div id="thing-test-results" style="padding-left: 115px; margin-bottom: 15px"></div>
  <div class="form-row">
    <label for="node-input-output"><i class="fa fa-list"></i> Output...</label>
    <select id="node-input-output" style="width: 70%">
      <option value="all">On all state updates</option>
      <option value="change">When any part of the state changes</option>
      <option value="path">Only when a part of the state changes...</option>
    </select>
  </div>
  <div class="form-row" id="row-outputPath">
    <label for="node-input-outputPath">&nbsp;</label>
    <input type="text" id="node-input-outputPath" />
  </div>
  <div class="form-row" id="row-outputTest">
    <label for="node-input-outputTest">&nbsp;</label>
    <div style="display: inline">
      <input
        type="checkbox"
        id="node-input-outputTest-checkbox"
        style="width: 14px; margin-bottom: 5px"
      />
      <span>And value</span>
      <select id="node-input-outputTest-compare" style="width: 110px"></select>
      <input type="text" id="node-input-outputTest-for" />
    </div>
  </div>
  <div class="form-row" id="row-ignoreInit">
    <label for="node-input-ignoreInit">&nbsp;</label>
    <input
      type="checkbox"
      id="node-input-ignoreInit"
      style="display:inline-block; width:15px; vertical-align:baseline;"
    />
    <span> Ignore initialization</span>
  </div>
  <div class="form-row">
    <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
    <select id="node-input-payload">
      <option value="whole">Whole State</option>
      <option value="path">Specific Path...</option>
    </select>
  </div>
  <div class="form-row" id="row-payloadPath">
    <label for="node-input-payloadPath">&nbsp;</label>
    <input type="text" id="node-input-payloadPath" />
  </div>
  <div class="form-row">
    <label for="node-input-incThing">&nbsp;</label>
    <input
      type="checkbox"
      id="node-input-incThing"
      style="display:inline-block; width:15px; vertical-align:baseline;"
    />
    <span> Include thing in output as <code>msg.thing</code></span>
  </div>
</script>

<script type="text/html" data-help-name="Thing Trigger">
  <p>A node that outputs a message when a thing's state changes. Can be configured in many ways.</p>
  <h3>Properties</h3>
  <dl class="message-properties">
    <dt class="required">Multi-thing Mode</dt>
    <dd>When enabled, allows multiple <i>things</i> to trigger this node</dd>
    <dt class="required">Thing Name</dt>
    <dd>(Single-thing mode) The <i>thing</i> <code>name</code> to trigger from</dd>
    <dt class="required">Thing Test</dt>
    <dd>
      (Multi-thing mode) Can be configured to check against any static attributes of each
      <i>thing</i>. List of matching <i>things</i> is made immediately after setup and is not
      updated until nodes are re-deployed. Each <i>thing</i> is tracked individually. Editor will
      show how many <i>things</i> match the current configuration. Click the number to see the full
      list.
    </dd>
    <dt class="required">Output...</dt>
    <dd>
      Configure <b>when</b> to trigger an output. If a state key is specified, certain values can be
      filtered as well. <i>Ignore initialization</i> option will prevent triggers when the value
      changes from <code>undefined</code>.
    </dd>
    <dt class="required">Payload</dt>
    <dd>Configure <b>what</b> to output on <code>msg.payload</code></dd>
  </dl>
  <h3>Output</h3>
  <dl class="message-properties">
    <dt class="required"><code>topic</code> <span class="property-type">string</span></dt>
    <dd><i>Thing</i> <code>name</code></dd>
    <dt class="required"><code>payload</code> <span class="property-type">any</span></dt>
    <dd>Depends on Payload property</dd>
    <dt class="required"><code>thing</code> <span class="property-type">object</span></dt>
    <dd>The entire thing object, only if selected in properties</dd>
  </dl>
</script>
